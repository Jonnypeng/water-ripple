/**
 * Water ripple effect.
 * Original code (Java) by Neil Wallis
 * Code snipplet adapted to Javascript by Sergey Chikuyonok
 * Code re-written as jQuery plugin by Andrei Varabyou
 */
(function(e,t,n,r){function u(t,n){this.element=t;this.options=e.extend({},o,n);this._defaults=o;this._name=s;var r=this;var i;if(t.tagName=="IMG")i=e(t).attr("src");else{var u=e(t).css("background-image");if(u!="none"){var a=/url\("{0,1}([^"]*)"{0,1}\)/;i=a.exec(u)[1]}}if(i){r.image=e("<img/>").attr("src",i).load(function(){r.init()})}}function a(){l();i.ctx.putImageData(i.ripple,0,0)}function f(e,t){e<<=0;t<<=0;for(var n=t-i.riprad;n<t+i.riprad;n++){for(var r=e-i.riprad;r<e+i.riprad;r++){i.ripplemap[i.oldind+n*i.width+r]+=512}}}function l(){var e,t,n,r,s,o,u;e=i.oldind;i.oldind=i.newind;i.newind=e;e=0;i.mapind=i.oldind;var a=i.width,f=i.height,l=i.ripplemap,c=i.mapind,h=i.newind,p=i.last_map,d=i.ripple.data,v=i.texture.data,m=i.half_width,g=i.half_height;for(var y=0;y<f;y++){for(var b=0;b<a;b++){r=l[c-a]+l[c+a]+l[c-1]+l[c+1]>>1;r-=l[h+e];r-=r>>5;l[h+e]=r;r=1024-r;u=p[e];p[e]=r;if(u!=r){t=((b-m)*r/1024<<0)+m;n=((y-g)*r/1024<<0)+g;if(t>=a)t=a-1;if(t<0)t=0;if(n>=f)n=f-1;if(n<0)n=0;o=(t+n*a)*4;s=e*4;d[s]=v[o];d[s+1]=v[o+1];d[s+2]=v[o+2]}++c;++e}}i.mapind=c}var i={};var s="waterripple",o={delay:30,riprad:3,line_width:20,arbitrary:1e3,onclick:false,onmove:false};u.prototype={init:function(){i.canvas=n.createElement("canvas");e(this.element).after(i.canvas);i.ctx=i.canvas.getContext("2d");i.width=e(this.element).width();i.height=e(this.element).height();i.delay=this.options.delay;i.riprad=this.options.riprad;i.line_width=this.options.line_width;i.half_width=i.width>>1;i.half_height=i.height>>1;i.size=i.width*(i.height+2)*2;i.oldind=i.width;i.newind=i.width*(i.height+3);i.mapind;i.ripplemap=[];i.last_map=[];i.step=i.line_width*2;i.count=i.height/i.line_width;i.canvas.width=i.width;i.canvas.height=i.height;if(this.element.tagName=="IMG")i.ctx.drawImage(this.element,0,0);else i.ctx.drawImage(this.image[0],0,0);e(this.element).hide();i.texture=i.ctx.getImageData(0,0,i.width,i.height);i.ripple=i.ctx.getImageData(0,0,i.width,i.height);for(var t=0;t<i.size;t++){i.last_map[t]=i.ripplemap[t]=0}setInterval(a,i.delay);if(this.options.arbitrary&&this.options.arbitrary!=0){var r=Math.random;f(r()*i.width,r()*i.height);setInterval(function(){f(r()*i.width,r()*i.height)},this.options.arbitrary)}if(this.options.onclick){i.canvas.onclick=function(e){f(e.offsetX||e.layerX,e.offsetY||e.layerY)}}if(this.options.onmove){i.canvas.onmousemove=function(e){f(e.offsetX||e.layerX,e.offsetY||e.layerY)}}}};e.fn[s]=function(t){return this.each(function(){if(!e.data(this,"plugin_"+s)){e.data(this,"plugin_"+s,new u(this,t))}})}})(jQuery,window,document)
